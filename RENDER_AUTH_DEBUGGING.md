# Render Authentication Error Debugging Guide

## Issue: Authentication Error After Clicking Verification Link

When clicking the verification link on Render (`https://axiom-ray0.onrender.com/api/auth/callback/email?...`), you're seeing an "Authentication Error" page.

## Common Causes & Solutions

### 1. ✅ Check NEXTAUTH_URL Environment Variable (MOST COMMON)

**Problem**: If `NEXTAUTH_URL` is not set correctly, verification links will be generated with the wrong domain.

**Solution**: 
1. Go to your Render dashboard: https://dashboard.render.com
2. Navigate to your web service (`asset-organizer`)
3. Go to **Environment** tab
4. Check that `NEXTAUTH_URL` is set to: `https://axiom-ray0.onrender.com`
   - **NOT** `http://localhost:3000`
   - **NOT** `http://axiom-ray0.onrender.com` (missing `s` in `https`)
   - **MUST BE** `https://axiom-ray0.onrender.com` (exact match with `https://`)

5. After updating, **redeploy** your service for changes to take effect.

### 2. ✅ Check NEXTAUTH_SECRET

**Problem**: If `NEXTAUTH_SECRET` is missing or incorrect, token verification will fail.

**Solution**:
1. In Render dashboard, go to **Environment** tab
2. Verify `NEXTAUTH_SECRET` is set (should be auto-generated by Render, but verify it exists)
3. If missing, generate one:
   ```bash
   openssl rand -base64 32
   ```
4. Add it to Render environment variables
5. Redeploy

### 3. ✅ Check Database Connection

**Problem**: If the database connection fails during token verification, authentication will fail.

**Solution**:
1. Verify `DATABASE_URL` is correctly set in Render (should be auto-populated if database is linked)
2. Check database service is running and accessible
3. Check Render logs for database connection errors:
   - Go to your service → **Logs** tab
   - Look for Prisma/database connection errors

### 4. ✅ Token Expiration

**Problem**: Verification tokens expire after 24 hours. If you're using an old link, it will fail.

**Solution**:
- Request a **new** sign-in link (don't use an old email link)
- Use the sign-in page: `https://axiom-ray0.onrender.com/auth/signin`
- Check the email was sent recently (within the last 24 hours)

### 5. ✅ Token Already Used

**Problem**: Each verification token can only be used once. If you've already clicked the link, it won't work again.

**Solution**:
- Request a new sign-in link
- Don't click the same link multiple times

### 6. ✅ Check Render Logs

**To debug the exact error:**

1. Go to Render dashboard → Your service → **Logs** tab
2. Click the verification link
3. Immediately check the logs for:
   - `❌ [Adapter] useVerificationToken` errors
   - Database connection errors
   - `❌ [SignIn Callback]` errors
   - `❌ [SignIn Event]` errors

**Look for specific error messages:**
- "No tokens found for identifier" → Token expired or already used
- "No matching token found" → Token mismatch (could be database sync issue)
- "Database connection error" → Database is down or `DATABASE_URL` is wrong
- "Token expired" → Request a new sign-in link

### 7. ✅ Verify All Required Environment Variables

Ensure all these are set in Render:

- ✅ `DATABASE_URL` (auto-populated from database service)
- ✅ `NEXTAUTH_URL` = `https://axiom-ray0.onrender.com`
- ✅ `NEXTAUTH_SECRET` (auto-generated or manually set)
- ✅ `NODE_ENV` = `production`
- ✅ `SENDGRID_API_KEY` (for sending emails)
- ✅ `EMAIL_FROM` or `FROM_EMAIL` (for email sender address)
- ✅ `AWS_ACCESS_KEY_ID`
- ✅ `AWS_SECRET_ACCESS_KEY`
- ✅ `AWS_S3_BUCKET_NAME`
- ✅ `AWS_REGION`
- ✅ `OPENAI_API_KEY`

## Quick Fix Checklist

1. [ ] Verify `NEXTAUTH_URL` = `https://axiom-ray0.onrender.com` (exact, with https://)
2. [ ] Verify `NEXTAUTH_SECRET` is set
3. [ ] Check Render logs immediately after clicking verification link
4. [ ] Request a NEW sign-in link (don't reuse old links)
5. [ ] Verify database is running and accessible
6. [ ] Redeploy after changing environment variables

## Testing After Fix

1. Request a new sign-in link from: `https://axiom-ray0.onrender.com/auth/signin`
2. Check your email for the verification link
3. Click the link (must be within 24 hours)
4. You should be redirected to the dashboard (not the error page)

## Still Having Issues?

Check the Render logs for the specific error and share:
- The exact error message from logs
- Screenshot of your Render environment variables (hide secrets)
- The error code from the URL (if present): `/auth/error?error=Verification`

The logs will show exactly what's failing during the token verification process.
